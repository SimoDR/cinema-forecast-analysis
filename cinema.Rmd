```{r}
library(XML)
# install.packages('dplyr')
library(dplyr)
library(ggplot2)
library(readr)
library(forecast)
library(readxl)
library(DIMORA)
library(cowplot)

```

## Italy data

```{r}
it_cinema <- read.csv("italy_data.csv")
it_cinema
```
Some cleaning

```{r}
it_cinema$Week <- as.numeric(as.character(it_cinema$Week))
it_cinema$Week <- as.numeric(as.character(it_cinema$Week))
it_cinema$Date <- with(it_cinema, as.Date(paste0(it_cinema$Year, "-01-01"), format="%Y-%m-%d", origin="1970-01-01") +
                                               as.difftime(it_cinema$Week, unit="weeks"))
it_cinema$Overall.Gross <- parse_number(it_cinema$Overall.Gross)

it_cinema <- it_cinema[order(as.Date(it_cinema$Date)),]

```

Plot

```{r,fig.width = 8,dpi=600}
ggplot( data = it_cinema, aes( Date, Overall.Gross )) + geom_line() 

```


## Pre-covid 


```{r}
# it_cinema_full = it_cinema
it_cinema_precovid = it_cinema[which(it_cinema$Date < "2020-03-01"),]
ggplot( data = it_cinema_precovid, aes( Date, Overall.Gross )) + geom_line() 

```
### Some EDA

Let's see what happens in 2010 and 2011

```{r fig.width=7}
ggplot( data = it_cinema_precovid[which(it_cinema_precovid$Year == 2010 | it_cinema_precovid$Year == 2011),], aes( Date, Overall.Gross )) + 
  geom_line() + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b")

```


```{r}
ggplot( data = it_cinema_precovid[which(it_cinema_precovid$Date >= "2010-12-12" & it_cinema_precovid$Date <= "2011-01-15"),], aes( Date, Overall.Gross )) + 
  geom_line() + 
  scale_x_date(date_breaks = "1 day", date_labels = "%d")

```

### Comulated distribution of gross per week

```{r}
it_cinema_week <-it_cinema_precovid %>% 
    group_by(Week) %>%
    summarize(Weekly.mean.gross = mean(Overall.Gross))

# it_cinema_week

ggplot(it_cinema_week, aes(x=Week, y=Weekly.mean.gross)) + geom_bar(stat="identity", width=0.5)
```

### Trends for periods

Cumulated gross for periods (christmas, autumn, summer) to see how they trend over the years
 
```{r}
christmas <- it_cinema_precovid[which(it_cinema_precovid$Week >= 48 | it_cinema_precovid$Week <= 5),]
christmas <- christmas %>%
    group_by(Year) %>%
    summarize(Overall.Gross = sum(Overall.Gross))

autumn <- it_cinema_precovid[which(it_cinema_precovid$Week >= 39 & it_cinema_precovid$Week <= 48),]
autumn <- autumn %>%
    group_by(Year) %>%
    summarize(Overall.Gross = sum(Overall.Gross))

summer <- it_cinema_precovid[which(it_cinema_precovid$Week >= 23 & it_cinema_precovid$Week <= 38),]
summer <- summer %>%
    group_by(Year) %>%
    summarize(Overall.Gross = sum(Overall.Gross))

```

```{r}

christmas_plot <- ggplot( ) + 
  geom_line(data = christmas, aes( Year, Overall.Gross ), color="blue") +
  scale_x_continuous(breaks = round(seq(min(autumn$Year), max(autumn$Year), by = 2),1))

autumn_plot <- ggplot( ) + 
  geom_line(data = autumn, aes( Year, Overall.Gross ), color="green") +
  scale_x_continuous(breaks = round(seq(min(autumn$Year), max(autumn$Year), by = 2),1))

summer_plot <- ggplot( ) + 
  geom_line(data = summer, aes( Year, Overall.Gross ), color="red") +
  scale_x_continuous(breaks = round(seq(min(autumn$Year), max(autumn$Year), by = 2),1))


plot_grid(christmas_plot, autumn_plot, summer_plot, labels = c("christmas","autumn","summer"))
```
### Bass model

```{r}
bm_GC<-BM(it_cinema_precovid$Overall.Gross,display = T,
          prelimestimates = c(sum(it_cinema_precovid$Overall.Gross) + 100, 0.001, 0.1),)
summary(bm_GC)

```


```{r}
dates <- c(it_cinema_precovid$Date,seq(as.Date("2020-03-01"), as.Date("2023-03-01"), "week"))
pred_bmGC<- predict(bm_GC, newx=c(1:length(dates)))
pred.instGC<- make.instantaneous(pred_bmGC)
pred_bm <- data.frame(cbind(dates,pred.instGC))
pred_bm$dates <- dates
pred_bm$pred.instGC <- pred.instGC
ggplot( ) +
  geom_line(data = it_cinema_precovid, aes( Date, Overall.Gross), color="red") +
  geom_line(data = pred_bm, aes( dates, pred.instGC), color="blue")

```


## Full time series (with covid)



```{r}
it_cinema_monthly <-it_cinema %>% 
    group_by(month = lubridate::floor_date(Date, "month")) %>%
    summarize(Montly.gross = sum(Overall.Gross))

ggplot( data = it_cinema_monthly, aes( month, Montly.gross )) + geom_line() 

```
### ACF and PACF

```{r}
acf(it_cinema_monthly$Montly.gross , lag.max = 50)
```

```{r}
pacf(it_cinema_monthly$Montly.gross , lag.max = 50)
```
### Linear regression

```{r}
fit1 <- lm(it_cinema$Overall.Gross ~ it_cinema$Date)
summary(fit1)

resfit1<- residuals(fit1)
plot(resfit1,xlab="Time", ylab="residuals" )

ggplot( ) +
  geom_line(data = it_cinema, aes( Date, Overall.Gross)) +
  geom_line(data = it_cinema, aes(Date, fitted(fit1)), color="red")
```
### Now with seasonality and trend
```{r}

#data transformed as time series
it_cinema.ts<-ts(it_cinema$Overall.Gross, frequency=52)

#Model with trend and seasonality
fit2 <- tslm(it_cinema.ts~ trend+season)
summary(fit2)

#check the residuals
res2 <- residuals(fit2)
plot(res2)

# fit1 <- lm(it_cinema$Overall.Gross ~ it_cinema$Date)
# summary(fit1)



ggplot( ) +
  geom_line(data = it_cinema, aes( Date, Overall.Gross)) +
  geom_line(data = it_cinema, aes(Date, fitted(fit2)), color="red")
```
### Loess

```{r}
lo1 <- loess.smooth(it_cinema$Date,it_cinema$Overall.Gross,span=0.1) 
ggplot( ) +
  geom_line(data = it_cinema, aes( Date, Overall.Gross)) +
  geom_line(data = data.frame(lo1), aes(lo1$x, lo1$y), color="red")

```


### Arima

```{r}
cinema_diff <- diff(it_cinema$Overall.Gross,lag=1)
ggtsdisplay(cinema_diff)
```


```{r,fig.width=20}
auto.arima<- auto.arima(it_cinema$Overall.Gross)
ggplot( ) +
  geom_line(data = it_cinema, aes( Date, Overall.Gross)) +
  geom_line(data = it_cinema, aes(Date, fitted(auto.arima)), color="red")

auto.arima
```


```{r, fig.width=20}
a2<- Arima(it_cinema$Overall.Gross, order=c(4,1,2), seasonal = c(1,0,0))
ggplot( ) +
  geom_line(data = it_cinema, aes( Date, Overall.Gross)) +
  geom_line(data = it_cinema, aes(Date, fitted(a2)), color="red")
a2
```
```{r}
auto.arima<- auto.arima(it_cinema_postcovid$Overall.Gross)
ggplot( ) +
  geom_line(data = it_cinema_postcovid, aes( Date, Overall.Gross)) +
  geom_line(data = it_cinema_postcovid, aes(Date, fitted(auto.arima)), color="red")

auto.arima
```





## Productions nationality


```{r}
prods <- read.csv("productions.csv")

prods$Date <- with(prods, as.Date(paste0(prods$Year, "-01-01"), format="%Y-%m-%d", origin="1970-01-01") +
                                               as.difftime(prods$Week, unit="weeks"))
prods
```
Italian productions in black, foreign in red

```{r}
ggplot( ) + 
  geom_line(data = prods, aes( Date, IT_movies )) +
  geom_line(data = prods, aes( Date, foreign_movies ),color="red") 
  geom_line(data = it_cinema, aes( Date, Overall.Gross/1000000),color="blue" )

```


## Netflix competition


```{r}
it_cinema_monthly$Montly.access = it_cinema_monthly$Montly.gross/7
```

```{r}
ggplot( ) +
  geom_line(data = it_cinema_monthly, aes( month, Montly.access), color="red") + 
  geom_line(data = it_netflix, aes( date, n_access ), color="blue")

```

```{r}
ucrcdNR<- UCRCD(it_cinema_monthly$Montly.access,it_netflix$n_access, display=T)
summary(ucrcdNR)

```
## Covid

```{r}
it_cinema_postcovid = it_cinema[which(it_cinema$Date > "2020-03-11"),]
```


```{r}
it_cinema_monthly <-it_cinema_postcovid %>% 
    group_by(month = lubridate::floor_date(Date, "month")) %>%
    summarize(Montly.gross = sum(Overall.Gross))

ggplot( data = it_cinema_monthly, aes( month, Montly.gross )) + geom_line() 

```

```{r}
bm_GC<-BM(it_cinema_postcovid$Overall.Gross,display = T,
          prelimestimates = c(sum(it_cinema_postcovid$Overall.Gross) + 100, 0.001, 0.01),)
summary(bm_GC)

dates <- it_cinema_postcovid$Date
pred_bmGC<- predict(bm_GC, newx=c(1:length(dates)))
pred.instGC<- make.instantaneous(pred_bmGC)
pred_bm <- data.frame(cbind(dates,pred.instGC))
pred_bm$dates <- dates
pred_bm$pred.instGC <- pred.instGC
ggplot( ) +
  geom_line(data = it_cinema_postcovid, aes( Date, Overall.Gross), color="red") +
  geom_line(data = pred_bm, aes( dates, pred.instGC), color="blue")


```


```{r}
bm_GC<-GBM(it_cinema_postcovid$Overall.Gross, display = T,
          shock="rett", nshock = 2,
          prelimestimates = c(sum(it_cinema_postcovid$Overall.Gross) + 100, 0.01, 0.01,
          0, 15, -0.8,
          15, 30, +1),
          # shock="rett", nshock = 3,
          # prelimestimates = c(sum(it_cinema$Overall.Gross) + 100, 0.01, 0.01,
          #                     1, 15, -1,
          #                     10, 20, +0.5,
          #                     20, 31, -0.5)


)
summary(bm_GC)

dates <- it_cinema_postcovid$Date
pred_bmGC<- predict(bm_GC, newx=c(1:length(dates)))
pred.instGC<- make.instantaneous(pred_bmGC)
pred_bm <- data.frame(cbind(dates,pred.instGC))
pred_bm$dates <- dates
pred_bm$pred.instGC <- pred.instGC
ggplot( ) +
  geom_line(data = it_cinema_postcovid, aes( Date, Overall.Gross), color="red") +
  geom_line(data = pred_bm, aes( dates, pred.instGC), color="blue")


```

## Prediction


```{r}
netflix_access <- c(rep(0,96),it_netflix$n_access)
```

```{r}
prods_monthly <-prods %>% 
    group_by(month = lubridate::floor_date(Date, "month")) %>%
    summarize(IT_movies = sum(IT_movies),foreign_movies = sum(foreign_movies) )

ggplot( ) + 
  geom_line(data = prods_monthly, aes( month, IT_movies )) +
  geom_line(data = prods_monthly, aes( month, foreign_movies ),color="red") 

```
```{r}
prods_monthly$perc <- prods_monthly$IT_movies/prods_monthly$foreign_movies
# prods_monthly <- na.omit(prods_monthly)
prods_monthly <- do.call(data.frame,lapply(prods_monthly, function(x) replace(x, is.infinite(x),NA)))
prods_monthly[is.na(prods_monthly)] <- 1
prods_monthly
```



```{r}
cinema_data <- merge(x = it_cinema_monthly, y = prods_monthly, by = "month", all = TRUE)
cinema_data$netflix_access <- netflix_access
cinema_data <- na.omit(cinema_data)
cinema_data
```



```{r}
fit3 <- lm(cinema_data$Montly.gross ~ cinema_data$perc + cinema_data$netflix_access)
summary(fit3)

resfit1<- residuals(fit3)
plot(resfit1,xlab="Time", ylab="residuals" )

ggplot( ) +
  geom_line(data = cinema_data, aes( month, Montly.gross)) +
  geom_line(data = cinema_data, aes(month, fitted(fit3)), color="red")

```

